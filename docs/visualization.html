---

title: Visualization


keywords: fastai
sidebar: home_sidebar

summary: "Creates a 3D visualization using matplotlib"
description: "Creates a 3D visualization using matplotlib"
nb_path: "nbs/10_visualization.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10_visualization.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_resolution" class="doc_header"><code>get_resolution</code><a href="https://github.tifx04-22-10.com/TIFX04-22-10/runningpose/tree/master/runningpose/core/visualization.py#L20" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_resolution</code>(<strong><code>filename</code></strong>)</p>
</blockquote>
<p>Returns the height and widht for a given video file.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_fps" class="doc_header"><code>get_fps</code><a href="https://github.tifx04-22-10.com/TIFX04-22-10/runningpose/tree/master/runningpose/core/visualization.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_fps</code>(<strong><code>filename</code></strong>)</p>
</blockquote>
<p>Returns the frames per second for a given video file.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_video" class="doc_header"><code>read_video</code><a href="https://github.tifx04-22-10.com/TIFX04-22-10/runningpose/tree/master/runningpose/core/visualization.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_video</code>(<strong><code>filename</code></strong>, <strong><code>skip</code></strong>=<em><code>0</code></em>, <strong><code>limit</code></strong>=<em><code>-1</code></em>)</p>
</blockquote>
<p>Loads a given video file and returns it as a data generator.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="downsample_tensor" class="doc_header"><code>downsample_tensor</code><a href="https://github.tifx04-22-10.com/TIFX04-22-10/runningpose/tree/master/runningpose/core/visualization.py#L64" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>downsample_tensor</code>(<strong><code>X</code></strong>, <strong><code>factor</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="render_animation" class="doc_header"><code>render_animation</code><a href="https://github.tifx04-22-10.com/TIFX04-22-10/runningpose/tree/master/runningpose/core/visualization.py#L69" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>render_animation</code>(<strong><code>keypoints</code></strong>, <strong><code>keypoints_metadata</code></strong>, <strong><code>poses</code></strong>, <strong><code>skeleton</code></strong>, <strong><code>fps</code></strong>, <strong><code>bitrate</code></strong>, <strong><code>azim</code></strong>, <strong><code>output</code></strong>, <strong><code>viewport</code></strong>, <strong><code>limit</code></strong>=<em><code>-1</code></em>, <strong><code>downsample</code></strong>=<em><code>1</code></em>, <strong><code>size</code></strong>=<em><code>6</code></em>, <strong><code>input_video_path</code></strong>=<em><code>None</code></em>, <strong><code>input_video_skip</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>TODO
Render an animation. The supported output modes are:
 -- 'interactive': display an interactive figure
        (also works on notebooks if associated with %matplotlib inline)
 -- 'html': render the animation as HTML5 video. Can be displayed in
        a notebook using HTML(...).
 -- 'filename.mp4': render and export the animation as an h264 video
        (requires ffmpeg).
 -- 'filename.gif': render and export the animation a gif file
    (requires imagemagick).</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">render_animation</span><span class="p">(</span>
        <span class="n">keypoints</span><span class="p">,</span> <span class="n">keypoints_metadata</span><span class="p">,</span> <span class="n">poses</span><span class="p">,</span> <span class="n">skeleton</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> 
        <span class="n">azim</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">viewport</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">input_video_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_video_skip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO</span>
<span class="sd">    Render an animation. The supported output modes are:</span>
<span class="sd">     -- &#39;interactive&#39;: display an interactive figure</span>
<span class="sd">            (also works on notebooks if associated with %matplotlib inline)</span>
<span class="sd">     -- &#39;html&#39;: render the animation as HTML5 video. Can be displayed in </span>
<span class="sd">            a notebook using HTML(...).</span>
<span class="sd">     -- &#39;filename.mp4&#39;: render and export the animation as an h264 video </span>
<span class="sd">            (requires ffmpeg).</span>
<span class="sd">     -- &#39;filename.gif&#39;: render and export the animation a gif file </span>
<span class="sd">        (requires imagemagick).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initializes the input plot (2D)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">poses</span><span class="p">)),</span> <span class="n">size</span><span class="p">))</span>
    <span class="n">ax_in</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">poses</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax_in</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_in</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_in</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">ax_in</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>

    <span class="c1"># This handles the 3D plot:</span>
    <span class="n">ax_3d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines_3d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">trajectories</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.7</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">poses</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">poses</span><span class="p">),</span> <span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">azim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim3d</span><span class="p">([</span><span class="o">-</span><span class="n">radius</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim3d</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim3d</span><span class="p">([</span><span class="o">-</span><span class="n">radius</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="mf">7.5</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="c1">#, pad=35</span>
        <span class="n">ax_3d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">lines_3d</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">poses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">poses</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>


    <span class="c1"># Decode video i.e the left side 2D plot</span>
    <span class="k">if</span> <span class="n">input_video_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Black background</span>
        <span class="n">all_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">keypoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">viewport</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">viewport</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load video using ffmpeg</span>
        <span class="n">all_frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">read_video</span><span class="p">(</span><span class="n">input_video_path</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">input_video_skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">):</span>
            <span class="n">all_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="n">effective_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">keypoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_frames</span><span class="p">))</span>
        <span class="n">all_frames</span> <span class="o">=</span> <span class="n">all_frames</span><span class="p">[:</span><span class="n">effective_length</span><span class="p">]</span>
        
        <span class="n">keypoints</span> <span class="o">=</span> <span class="n">keypoints</span><span class="p">[</span><span class="n">input_video_skip</span><span class="p">:]</span> <span class="c1"># todo remove</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">poses</span><span class="p">)):</span>
            <span class="n">poses</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">poses</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">input_video_skip</span><span class="p">:]</span>
        
        <span class="k">if</span> <span class="n">fps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="n">get_fps</span><span class="p">(</span><span class="n">input_video_path</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">downsample</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">keypoints</span> <span class="o">=</span> <span class="n">downsample_tensor</span><span class="p">(</span><span class="n">keypoints</span><span class="p">,</span> <span class="n">downsample</span><span class="p">)</span>
        <span class="n">all_frames</span> <span class="o">=</span> <span class="n">downsample_tensor</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_frames</span><span class="p">),</span> <span class="n">downsample</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">poses</span><span class="p">)):</span>
            <span class="n">poses</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">downsample_tensor</span><span class="p">(</span><span class="n">poses</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">downsample</span><span class="p">)</span>
            <span class="n">trajectories</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">downsample_tensor</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">downsample</span><span class="p">)</span>
        <span class="n">fps</span> <span class="o">/=</span> <span class="n">downsample</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">image</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_frames</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_frames</span><span class="p">))</span>
    
    <span class="n">parents</span> <span class="o">=</span> <span class="n">skeleton</span><span class="o">.</span><span class="n">parents</span><span class="p">()</span>
    <span class="c1"># Holds all the associated values to each joint in the skeleton </span>
    <span class="c1"># model that is needed to calculate a specific angle. </span>
    <span class="n">joints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;LElbow&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
        <span class="s2">&quot;RElbow&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">],</span>
        <span class="s2">&quot;Neck&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;Spine&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="s2">&quot;LKnee&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span>
        <span class="s2">&quot;RKnee&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span>
        <span class="s2">&quot;LFot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
        <span class="s2">&quot;RFot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="c1"># Instansiate a dictionary that holds all angle calculations for the joints</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">update_video</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Updates the video with a new frame, used in FuncAnim.&quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">initialized</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">points</span>

            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_3d</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim3d</span><span class="p">(</span>
                    <span class="p">[</span><span class="o">-</span><span class="n">radius</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span> 
                    <span class="o">+</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim3d</span><span class="p">(</span>
                    <span class="p">[</span><span class="o">-</span><span class="n">radius</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span> 
                    <span class="o">+</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="p">)</span>

            <span class="c1"># Update 2D poses</span>
            <span class="n">joints_right_2d</span> <span class="o">=</span> <span class="n">keypoints_metadata</span><span class="p">[</span><span class="s1">&#39;keypoints_symmetry&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">colors_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">keypoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">colors_2d</span><span class="p">[</span><span class="n">joints_right_2d</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
            
            <span class="c1"># This runs the first time we render animation.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">initialized</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">ax_in</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">all_frames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
                
                <span class="c1"># NOTE: pos is (num_joints_out, dim) for each frame</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">j_parent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parents</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j_parent</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                        
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="n">keypoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="n">keypoints_metadata</span><span class="p">[</span><span class="s1">&#39;layout_name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;coco&#39;</span><span class="p">:</span>
                        <span class="c1"># Draw skeleton only if keypoints match (otherwise </span>
                        <span class="c1"># we don&#39;t have the parents definition)</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_in</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j_parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j_parent</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> 
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Color of the skelton</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">skeleton</span><span class="o">.</span><span class="n">joints_right</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;black&#39;</span>
                    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_3d</span><span class="p">):</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">poses</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">lines_3d</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">j_parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">j_parent</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">j_parent</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
                        <span class="p">)</span>
                        
                <span class="c1"># Angle calculation</span>
                <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">joints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">keyp</span> <span class="o">=</span> <span class="n">joints</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_calc</span><span class="p">(</span>
                        <span class="n">pos</span><span class="p">[</span><span class="n">keyp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:],</span> 
                        <span class="n">pos</span><span class="p">[</span><span class="n">keyp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> 
                        <span class="n">pos</span><span class="p">[</span><span class="n">keyp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="n">angles</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">angle</span><span class="p">]</span>
                    
                <span class="n">points</span> <span class="o">=</span> <span class="n">ax_in</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors_2d</span><span class="p">,</span> 
                    <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
                <span class="p">)</span>

                <span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">all_frames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># NOTE: pos is (num_joints_out, dim) for each frame</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">j_parent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parents</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j_parent</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="n">keypoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">keypoints_metadata</span><span class="p">[</span><span class="s1">&#39;layout_name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;coco&#39;</span><span class="p">:</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j_parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j_parent</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
                        <span class="p">)</span>

                    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_3d</span><span class="p">):</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">poses</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">lines_3d</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">j_parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]))</span>
                        <span class="n">lines_3d</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">j_parent</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
                        <span class="n">lines_3d</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_3d_properties</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">j_parent</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]),</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
                        
                <span class="c1"># Angle calculation</span>
                <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">joints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">keyp</span> <span class="o">=</span> <span class="n">joints</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_calc</span><span class="p">(</span>
                        <span class="n">pos</span><span class="p">[</span><span class="n">keyp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:],</span> 
                        <span class="n">pos</span><span class="p">[</span><span class="n">keyp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> 
                        <span class="n">pos</span><span class="p">[</span><span class="n">keyp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="n">angles</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

                <span class="n">points</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">limit</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">update_video</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">),</span> 
        <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span><span class="o">/</span><span class="n">fps</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">):</span>
        <span class="n">Writer</span> <span class="o">=</span> <span class="n">writers</span><span class="p">[</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">]</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span> <span class="n">bitrate</span><span class="o">=</span><span class="n">bitrate</span><span class="p">)</span>
        <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gif&#39;</span><span class="p">):</span>
        <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Unsupported output format (only .mp4 and .gif are supported)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Save angles as a json file for web app to read.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;angles.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Angle-Calculation">Angle Calculation<a class="anchor-link" href="#Angle-Calculation"> </a></h2><blockquote><p>Function that handle calculating the runners joint angels.</p>
</blockquote>
<p>We use the dot product rule:$a \cdot b = \lVert a \rVert \lVert b \rVert cos(\theta)$.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unit_vector" class="doc_header"><code>unit_vector</code><a href="https://github.tifx04-22-10.com/TIFX04-22-10/runningpose/tree/master/runningpose/core/visualization.py#L302" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unit_vector</code>(<strong><code>vector</code></strong>)</p>
</blockquote>
<p>Returns the unit vector of the vector.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="angle_calc" class="doc_header"><code>angle_calc</code><a href="https://github.tifx04-22-10.com/TIFX04-22-10/runningpose/tree/master/runningpose/core/visualization.py#L307" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>angle_calc</code>(<strong><code>front_keypoint</code></strong>, <strong><code>mid_keypoint</code></strong>, <strong><code>end_keypoint</code></strong>)</p>
</blockquote>
<p>Calculates and returns the degree (angle) between two vectors</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

